#!/bin/bash

function prolog() {
    if [ "$debug" = "true" ]; then
       echo "== $1 ============================================================================================================="
       echo ""
    else
       echo "== $1 =============================================================================================================" >> log.txt 2>&1
       echo "" >> log.txt 2>&1
    fi;
}

function log() {
    if [ "$debug" = "true" ]; then
       echo $1
    fi;
    echo $1 >> log.txt 2>&1
}

function r {
    if [ $L_STATUS -ne 0 ]; then
        return $L_STATUS;
    fi;
    if [ "$failFast" = "true" ]; then
        if [ $G_STATUS -ne 0 ]; then
            return $G_STATUS;
        fi;
    fi;
    if [ "$debug" = "true" ]; then
       #echo $CTX: $G_STATUS
       echo "$@"
       echo ""
       "$@"
    else
       echo "$@" >> log.txt 2>&1
       echo "" >> log.txt 2>&1
       "$@" >> log.txt 2>&1
    fi;

    local status=$?
    if [ $status -ne 0 ]; then
        G_STATUS=$status
        L_STATUS=$status
        log "FAILED:$CTX"
    fi
    return $status
}

function mkdirp() {
    log "creating directory [$1]"
    mkdir -p $1 > /dev/null 2>&1 | true
}

function cpwsdl() {
    log "copying [$1/$2] to [services/$SVC_DIR/war/WEB-INF/wsdl/]"

    #create directories for target file ...
    mkdir -p services/$SVC_DIR/war/WEB-INF/wsdl/$2
    rm -rf services/$SVC_DIR/war/WEB-INF/wsdl/$2

    # make actual copy ...
    cp -v $1/$2 services/$SVC_DIR/war/WEB-INF/wsdl/$2 > /dev/null 2>&1 | true
}

function cpclasses() {
    log "copying [$1] to [services/$SVC_DIR/war/WEB-INF/classes/]"
    cp $1 services/$SVC_DIR/war/WEB-INF/classes/ > /dev/null 2>&1 | true
}

function prepareModule() {
    MODULE=$1
    MODS=/Users/miran/dev/jigsaw/TESTS/JAXWS/unit/mods

    log "preparing module [$MODULE]"

    mkdir -p ../mods/

    #no module-info.java generating
    cp -r $MODS/$MODULE ../mods/
    rm -rf ../mods/$MODULE/module-info.*

    mkdir -p ../mods/$MODULE/bsh

    # SERVER
    if [ "$MODULE" = "server" ]; then
        # TODO: this is server!
        if [ -f services/$SVC_DIR/gen-src/module-info.java ]; then
            echo "CHECK THIS: $CTX services/$SVC_DIR/gen-src/module-info.java " >> log.txt 2>&1
            cp -r services/$SVC_DIR/gen-src/module-info.java ../mods/server/
        fi;

        if [ -d services/$SVC_DIR/war/WEB-INF/classes ]; then
            cp -r services/$SVC_DIR/war/WEB-INF/classes/* ../mods/server/
        fi;

        cp -r bsh/Deploy*.class ../mods/server/bsh
        cp -r bsh/Endpoint*.class ../mods/server/bsh

#        # module-info generated by ws-tools
#        cp -r services/$SVC_DIR/war/WEB-INF/classes/module-info.java ../mods/$MODULE/
    else
        cp -r client-classes/* ../mods/$MODULE/  > /dev/null 2>&1 | true
        cp -r client-source/module-info.java ../mods/$MODULE/  > /dev/null 2>&1 | true

#        # module-info generated by ws-tools
#        cp -r client-source/module-info.java ../mods/$MODULE/

        # aleady in client-classes ...
        #cp -r bsh/Client*.class ../mods/$MODULE/bsh
    fi;

    if [ -f ../mods/$MODULE/module-info.java ]; then
        r javac ../mods/$MODULE/module-info.java
    else
        echo "FAILED: $CTX: mising module-info.java!!!!" >> log.txt 2>&1
        export G_STATUS=1
        return -1;
    fi;
}

function runjavabg() {
    CP=$1
    CLAZZ=$2
    MODULE=server
    J_OPTIONS="-cp $CP $CLAZZ"

    if [ "$useNamedModule" = "true" ]; then
        prepareModule $MODULE
        J_OPTIONS="-mp ../mods -m $MODULE/$CLAZZ"
        # nothing for cp mode
    else
        rm -rf services/$SVC_DIR/war/WEB-INF/classes/module-info.* > /dev/null 2>&1
        rm -rf services/$SVC_DIR/gen-src/module-info.* > /dev/null 2>&1
    fi;

    if [ "$debug" = "true" ]; then
       echo "java $JAVA_OPTS $J_OPTIONS &


       "
       r java $JAVA_OPTS $J_OPTIONS &
    else
       echo "java $JAVA_OPTS $J_OPTIONS" >> log.txt 2>&1
       r java $JAVA_OPTS $J_OPTIONS >> log.txt 2>&1 &
    fi;
}

function runjava() {
    CP=$1
    CLAZZ=$2
    MODULE=client
    J_OPTIONS="-cp $CP $CLAZZ"

    if [ "$useNamedModule" = "true" ]; then
        prepareModule $MODULE
        J_OPTIONS="-mp ../mods -m $MODULE/$CLAZZ"
        # nothing for cp mode
    else
        rm -rf client-source/module-info.* > /dev/null 2>&1
        rm -rf client-classes/module-info.* > /dev/null 2>&1
    fi;

    if [ "$debug" = "true" ]; then
       echo "java $JAVA_OPTS $J_OPTIONS"
       r java $JAVA_OPTS $J_OPTIONS
    else
       echo "java $JAVA_OPTS $J_OPTIONS" >> log.txt 2>&1
       r java $JAVA_OPTS $J_OPTIONS >> log.txt 2>&1
    fi;
}
