#!/bin/bash -ex
# service id: ${serviceId}
# stage: ${stage}
L_STATUS=0

if [ "$failFast" = "true" ]; then
    if [ "$G_STATUS" = "1" ]; then
       return 1
    fi;
fi;

if [ "$skipTests" != "true" ]; then

    TOTAL_STEPS=$((TOTAL_STEPS+1))

    export CTX="${serviceId}:${stage}-client(${testName})"

    . shared

    prolog $CTX

    log "Running ${testName}"

    # TODO: what about JUnit??? compile also ../src/client?
    if [ -d "../src/junit" ]; then
        SRC_FILES=`find ../src/junit -name '*.java'`
        r javac -cp client-classes:. -d client-classes $SRC_FILES
    fi
    # compile generated client sources
    SRC_FILES=
    if [ -d "client-source" ]; then
        SRC_FILES=`find client-source -name '*.java'`
        r javac -cp ${classpath} -d client-classes $SRC_FILES
    fi
    # TODO: introduce hash fcion
    if [ -d "../src/common" ]; then
        SRC_FILES=`find ../src/common -name '*.java'`
        r javac -cp client-classes:. -d client-classes $SRC_FILES
    fi
    # TODO: what about JUnit??? compile also ../src/client?
    if [ -d "../src/client" ]; then
        SRC_FILES=`find ../src/client -name '*.java'`
        r javac -cp client-classes:. -d client-classes $SRC_FILES
    fi

    # compile generated bash.Client#.java
    r javac -cp ${classpath} -d client-classes \
         bsh/Client${stage}.java bsh/Util.java

    # actual running client
    runjava ${classpath} bsh.Client${stage}
    #r sleep 1
fi;