import javax.xml.ws.*;
import javax.jws.*;
import javax.xml.namespace.*;

if (!fromWsdl) {
    for( endpoint : endpoints ) {
          bean = create(
              endpoint.name,
              endpoint.className,
              null,
              null,
              null,
              null,
              "/"+endpoint.name);
          beans.add(bean);
    }
} else {
    portNames = new ArrayList();
    // if we find multiple implClass, use the port local name to match them
    portNameToImpl = new HashMap();

    wsca = null;
    implClass=null;

    for( className : classNames ) {
        clazz = loader.loadClass(className);
        a = clazz.getAnnotation(WebServiceClient.class);
        if(a!=null) {
            wsca = a;
            for ( method : clazz.getMethods()) {
                a = method.getAnnotation(WebEndpoint.class);
                if (a != null && method.getParameterTypes().length==0) {
                    String name = a.name();
                    if (!name.equals("")) {
                        portNames.add(name);
                    }
                }
            }
        }

        a = clazz.getAnnotation(WebService.class);
        if(a!=null) {
            sei = a.endpointInterface();
            if(!sei.equals(""))
              implClass = clazz.getName();
        } else {
            a = clazz.getAnnotation(WebServiceProvider.class);
            if (a!=null)
                implClass = clazz.getName();
        }
        if(a!=null && !a.portName().equals(""))
          portNameToImpl.put(a.portName(),implClass);
    }

    // create endpoint info beans
    tns = wsca.targetNamespace();

    // hacky
    wsdlLocation = wsca.wsdlLocation();
    wsdlLocation = wsdlLocation.replace('\\', '/');
    wsdlLocation = "WEB-INF/wsdl/" +
        wsdlLocation.substring(
        wsdlLocation.lastIndexOf("/") + 1,
        wsdlLocation.length());

    i=0;
    for (String portName : portNames) {
        impl = portNameToImpl.get(portName);
        portNameToImpl.remove(portName);
        if(impl==null)
          impl = implClass; // default

        // call EndpointInfoBean.create thanks to static import.
        // this allows us to create an instance of class that's not visible to this classloader.
        bean = create(
            "endpoint"+(i++),
            impl,
            wsdlLocation,
            new QName(tns, wsca.name()),
            new QName(tns, portName),
            "binding",
            "/" + service.getEndpointByImpl(impl).name);
        beans.add(bean);
    }

    // error check
    if(!portNameToImpl.isEmpty())
      throw new Exception("Implementations "+new ArrayList(portNameToImpl.values())+" don't have corresponding ports in WSDL."+
       " Their declared ports are "+new ArrayList(portNameToImpl.keySet())+
       " but actual ports are "+portNames
       );
}
